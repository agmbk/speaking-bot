import e from"fs";import f from"cleverbot-free";import*as g from"google-tts-api";import{Client as a,GatewayIntentBits as b,Partials as c}from"discord.js";import{joinVoiceChannel as h,createAudioResource as i,createAudioPlayer as j}from"@discordjs/voice";import d from"dotenv";import k from"https";import l from"rimraf";d.config();let intents=[];for(let[key,value]of Object.entries(b))Number.isInteger(value)&&intents.push(value);let partials=[];for(let[key,value]of Object.entries(c))Number.isInteger(value)&&partials.push(value);let client=new a({intents:intents,partials:partials}),guild,vocal,delay=a=>new Promise(b=>setTimeout(b,a)),auto=!1,speak=!1,mp3="./audio/.mp3";function play(){let b=h({channelId:process.env.VOCAL_ID,guildId:process.env.GUILD_ID,adapterCreator:guild.voiceAdapterCreator}),a=j(),c=i(mp3);a.play(c),b.subscribe(a)}async function chatbot(a){context.length>30&&context.shift();let b=await f(a,context,"FRANCE");return context.push(a),b}let context=[];client.once("ready",async a=>{console.log("Bot started"),vocal=(guild=client.guilds.cache.get(process.env.GUILD_ID)).channels.cache.get(process.env.VOCAL_ID)}),client.on("messageCreate",async a=>{if("1005466814576336956"===a.channel.id){if(a.content.includes("`")||"disable auto mode"===a.content)return;if(a.author.bot){if(!auto)return;a.reference.messageId&&await delay(new Date().getTime()-a.createdTimestamp+5e3)}else{if(a.content.startsWith("auto")){(auto=!auto)?(await a.reply("`Speak to itself : enabled`"),await a.reply(await chatbot(a.content.replace("auto","")))):await a.reply("`Speak to itself : disabled`");return}if("speak"===a.content){(speak=!speak)?await a.reply("`Voice output : enabled`"):await a.reply("`Voice output : disabled`");return}if("help"===a.content){await a.reply("**Commands**\n`speak` (Voice output toggle)\n`auto` + starting message (Bot reply to itself from starting message)\n`repeat` + message (Bot will repeat message)");return}if(auto){await a.reply("`disable auto mode to speak`");return}}let b=a.content,c=(b=b.startsWith("repeat")?b.replace("repeat",""):await chatbot(a.content)).includes("*");if(b=b.replace(/[^a-zA-Z0-9âéêèîôûç \n]+/g,""),speak&&b.length<200){try{e.unlinkSync(mp3)}catch{}k.get(g.getAudioUrl(b,{lang:"fr",slow:c,host:"https://translate.google.com"}),async b=>{let a=e.createWriteStream(mp3);b.pipe(a),a.on("finish",()=>{a.close(),play()})})}await a.reply(b)}}),client.login(process.env.TOKEN)